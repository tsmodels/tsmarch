---
title: "GOGARCH Demo"
author: "Alexios Galanos"
date: "`r Sys.Date()`"
output: 
    rmarkdown::html_vignette:
        css: custom.css
        code_folding: show
bibliography: tsmarch.bib
vignette: >
  %\VignetteIndexEntry{GOGARCH Demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

In this demo, we use the GOGARCH model generate a 1-step ahead forecast of the 
value at risk of an equally weighted combination of the modelled series using
a filtering/no re-stimation approach which is a simple way to backtest.

Load and prepare the data. We leave out 90 weeks for out of sample forecasting.
```{r data_setup}
suppressWarnings(library(xts))
suppressWarnings(library(tsmarch))
suppressWarnings(library(future))
RcppParallel::setThreadOptions(numThreads = 1)
plan(multisession, workers = 1)
options(future.globals.maxSize = 850 * 1024^2)
# GOGARCH Model
sample_index <- 1:1600
filter_index <- 1601:1690
data("globalindices", package = "tsmarch")
globalindices <- as.xts(globalindices)
```

Initial conditional mean filtration using an AR(1) model.

```{r mean_filtration}

```
Estimate the model.

```{r estimation}
spec <- gogarch_modelspec(globalindices[sample_index,], distribution = "nig", model = "egarch", order = c(1,1), components = 6)
mod <- estimate(spec)
```

Create a function to iterate through the out of sample data, forecast, aggregate and calculcate the 1% and 5% value at risk.


```{r}
iterate_fun <- function(model, new_data = NULL, h = 1, weights = NULL)
{
  nsim <- 1000
  if (is.null(weights)) weights <- rep(1/model$spec$n_series, model$spec$n_series)
  if (is.null(new_data)) {
    p <- predict(model, h = h, nsim = nsim, sim_method = "parametric", seed = 100)
    conv <- tsconvolve(p, weights = weights, fft_support = NULL)
    V <- sapply(1:nsim, function(i) {
      q <- qfft(conv, index = 1, sim = i)
      q(0.01)
    })
  } else {
    model <- tsfilter(model, y = new_data)
  }
  
}
  
```
